@{
    ViewData["Title"] = "老闆登入";
}
@section Styles {
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <link rel="stylesheet" href="~/css/calendar-common.css" />
    <style>
        /* ===== Boss 統計資料區：橘黃色系 ===== */
        .stats-container {
            background-color: #fffaf0;
            border: 2px solid #ffd54f;
            border-radius: 15px;
            padding: 25px;
            margin-top: 40px;
            box-shadow: 0 0 12px rgba(255, 193, 7, 0.3);
        }

            .stats-container h4 {
                color: #b8860b;
                font-weight: 700;
                text-align: center;
                margin-bottom: 25px;
                letter-spacing: 1px;
            }

        .card {
            border-radius: 0.5rem;
            border: 2px solid #ffd54f;
            box-shadow: 0 4px 8px rgba(255, 165, 0, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

            .card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 16px rgba(255, 165, 0, 0.25);
            }

        .card-header {
            font-weight: bold;
            text-align: center;
            background: linear-gradient(90deg, #ffe082, #fbbf24);
            color: #5c3c00;
            border-bottom: none;
            letter-spacing: 1px;
        }

        .table {
            background-color: #fffdf6;
            border-color: #fcd34d;
        }

            .table th {
                background-color: #fff8dc;
                color: #8b6b00;
                font-weight: 600;
            }

            .table tbody tr:hover {
                background-color: #fff7e6;
            }

        #rankingList li {
            background-color: #fffaf0;
            border: 1px solid #fde68a;
            color: #92400e;
            font-weight: 500;
            transition: background-color 0.2s;
        }

            #rankingList li:hover {
                background-color: #fde68a;
            }

        #rankingList span.badge {
            background-color: #f59e0b !important;
        }

        /* 金牌前三名漸層效果 */
        .rank-1 {
            background: linear-gradient(90deg, #fff9c4, #fde68a);
        }

        .rank-2 {
            background: linear-gradient(90deg, #fff7ed, #ffecb3);
        }

        .rank-3 {
            background: linear-gradient(90deg, #fffaf0, #fff59d);
        }
    </style>
}
<input type="hidden" id="currentUserId" value="@ViewData["UserId"]" />

<div id="calendar"></div>

<!-- 🧮 統計資料區 -->
<div class="container stats-container">
    <h4>員工出勤統計</h4>
    <div class="row">
        <!-- 該月統計 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">本月上班天數</div>
                <div class="card-body">
                    <table class="table table-sm table-bordered text-center" id="monthlyTable">
                        <thead>
                            <tr>
                                <th>員工姓名</th>
                                <th>天數</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 該年統計 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">年度上班天數</div>
                <div class="card-body">
                    <table class="table table-sm table-bordered text-center" id="yearlyTable">
                        <thead>
                            <tr>
                                <th>員工姓名</th>
                                <th>天數</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 排行榜 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">本月上班排行榜</div>
                <div class="card-body">
                    <ol id="rankingList" class="list-group list-group-numbered"></ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🧭 操作按鈕 -->
<div class="d-flex justify-content-end mb-3">
    <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#addTripModal">
        <i class="bi bi-briefcase-fill"></i> 新增出差工作
    </button>
    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editRoleModal">
        <i class="bi bi-person-gear"></i> 管理員工角色
    </button>
</div>

<!-- 🚗 新增出差工作 + 排班 -->
<div class="modal fade" id="addTripModal" tabindex="-1" aria-labelledby="addTripModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="addTripModalLabel">新增出差工作</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label>出差名稱：</label>
                        <input type="text" id="tripName" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label>出差地點：</label>
                        <input type="text" id="tripLocation" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label>出差日期：</label>
                        <input type="date" id="tripDate" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label>開始時間：</label>
                        <input type="time" id="tripStart" class="form-control" value="09:00">
                    </div>
                    <div class="col-md-4">
                        <label>結束時間：</label>
                        <input type="time" id="tripEnd" class="form-control" value="18:00">
                    </div>
                    <div class="col-12">
                        <label>備註：</label>
                        <textarea id="tripNote" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-warning" onclick="submitBusinessTrip()">新增</button>
            </div>
        </div>
    </div>
</div>


<!-- 👥 修改角色 Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-labelledby="editRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="editRoleModalLabel"><i class="bi bi-person-gear"></i> 修改員工角色</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <select id="userSelect" class="form-select mb-3"></select>

                <select id="roleSelect" class="form-select">
                    <option value="1">改為老闆</option>
                    <option value="2">改為主管</option>
                    <option value="3">改為員工</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-warning" onclick="updateUserRole()">更新</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/calendar-common.js"></script>

    <script>
            document.addEventListener("DOMContentLoaded", async () => {
             // ✅ 檢查 FullCalendar 是否已載入
            if (typeof FullCalendar === 'undefined') {
                console.error('FullCalendar 尚未載入');
                return;
            }
            // ✅ 確認 DOM 元素存在
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                console.error('找不到 calendar 元素');
                return;
            }
            try {
                const calendar = await initScheduleCalendar("calendar", 1);

                        if (!calendar) {
                console.group("❌ Calendar 初始化失敗偵錯");
                if (typeof FullCalendar === "undefined") {
                    console.error("原因：FullCalendar 未正確載入 (可能 CDN 錯誤或未引入 JS)");
                } else if (!document.getElementById("calendar")) {
                    console.error("原因：找不到 #calendar 容器元素，請確認 Boss.cshtml 有 <div id='calendar'>");
                } else {
                    console.error("原因：initScheduleCalendar() 回傳 null，可能是內部發生例外");
                    console.info("➡ 請檢查 console 是否有出現 '❌ initScheduleCalendar 發生錯誤'");
                    console.info("➡ 或查看 /Boss/GetAllSchedules 是否回傳 500 / 空集合");
                }
                console.groupEnd();
                return;
            }

                console.log('Calendar 初始化成功');

                loadUserList();

                const today = new Date();
                await loadStatistics(today.getFullYear(), today.getMonth() + 1);

                // ✅ 使用 on 方法監聽 datesSet 事件
            calendar.on('datesSet', async (info) => {
                console.log('datesSet 觸發:', info.view.currentStart);
                const viewDate = info.view.currentStart;
                await loadStatistics(viewDate.getFullYear(), viewDate.getMonth() + 1);
            });

                // ✅ 設定出差日期最小值為明天
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const minDate = tomorrow.toISOString().split('T')[0];
                document.getElementById('tripDate').setAttribute('min', minDate);

                // ✅ Modal 開啟時清空表單
                const addTripModal = document.getElementById('addTripModal');
                addTripModal.addEventListener('show.bs.modal', function () {
                    clearTripForm();
                });

            } catch (error) {
                console.error('Calendar 初始化過程發生錯誤:', error);
            }
        });

        // ✅ 清空出差表單的函數
        function clearTripForm() {
            document.getElementById('tripName').value = '';
            document.getElementById('tripLocation').value = '';
            document.getElementById('tripDate').value = '';
            document.getElementById('tripStart').value = '09:00';
            document.getElementById('tripEnd').value = '18:00';
            document.getElementById('tripNote').value = '';
        }

        // ✅ 修正版：送出含時區的時間
        async function submitBusinessTrip() {
            const name = $("#tripName").val().trim();
            const loc = $("#tripLocation").val().trim();
            const date = $("#tripDate").val();
            const start = $("#tripStart").val();
            const end = $("#tripEnd").val();
            const note = $("#tripNote").val();

            if (!name || !date) {
                Swal.fire("請填寫完整資料", "出差名稱與日期為必填", "warning");
                return;
            }

            // ✅ 檢查日期是否為今天之後
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selectedDate <= today) {
                Swal.fire("日期錯誤", "出差日期必須選擇明天之後", "warning");
                return;
            }

            // ✅ 加入台北時區 +08:00，轉為 ISO 格式
            const startTime = new Date(`${date}T${start}:00+08:00`).toISOString();
            const endTime = new Date(`${date}T${end}:00+08:00`).toISOString();

            const res = await fetch(`/api/ScheduleApi/AddBusinessTrip`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    WorkName: name,
                    WorkLocation: loc,
                    WorkNote: note,
                    StartTime: startTime,
                    EndTime: endTime
                })
            });

            // const data = await res.json();
            // if (data.success) {
            //     Swal.fire("成功", data.message, "success");
            //     $("#addTripModal").modal("hide");
            //     clearTripForm(); ✅ 成功後清空表單
            //     calendar.refetchEvents();
            //     const currentDate = calendar.getDate(); 取得日曆當前顯示的日期
            //     await loadStatistics(currentDate.getFullYear(), currentDate.getMonth() + 1);
            // } else {
            //     Swal.fire("錯誤", data.message, "error");
            // }
            const data = await res.json();
            if (data.success) {
                Swal.fire("成功", data.message, "success");
                $("#addTripModal").modal("hide");
                clearTripForm();

                // ✅ 使用全域的 calendar 變數重新載入事件
                if (window.calendar) {
                    window.calendar.refetchEvents();
                }
            } else {
                Swal.fire("錯誤", data.message, "error");
            }

        }

            async function loadUserList() {
            const res = await fetch(`/Boss/GetAllUsers`);
            const users = await res.json();
            $("#userSelect").empty();

            users.forEach(u => {
                let roleName = "";
                switch (u.roleId) {
                    case 1:
                        roleName = "老闆";
                        break;
                    case 2:
                        roleName = "主管";
                        break;
                    case 3:
                        roleName = "員工";
                        break;
                    default:
                        roleName = "未知角色";
                        break;
                }

                $("#userSelect").append(
                    `<option value="${u.userId}">${u.userName}（目前角色：${roleName}）</option>`
                );
            });
        }


        async function updateUserRole() {
            const userId = $("#userSelect").val();
            const roleId = $("#roleSelect").val();

            const res = await fetch(`/Boss/UpdateUserRole`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ UserId: parseInt(userId), RoleId: parseInt(roleId) })
            });
            const data = await res.json();
            if (data.success) {
                Swal.fire("成功", data.message, "success");
                $("#editRoleModal").modal("hide");
            } else {
                Swal.fire("錯誤", data.message, "error");
            }
        }

        async function loadStatistics(year, month) {
            try {
                const res = await fetch(`/Boss/GetMonthlyStats?year=${year}&month=${month}`);
                const data = await res.json();

                // 清空舊資料
                $("#monthlyTable tbody").empty();
                $("#yearlyTable tbody").empty();
                $("#rankingList").empty();

                if (!data || data.length === 0) {
                    $("#monthlyTable tbody").append(`<tr><td colspan='2'>無資料</td></tr>`);
                    $("#yearlyTable tbody").append(`<tr><td colspan='2'>無資料</td></tr>`);
                    $("#rankingList").append(`<li class="list-group-item">無資料</li>`);
                    return;
                }

                // 本月與本年統計表格
                data.forEach(item => {
                    $("#monthlyTable tbody").append(`
                        <tr>
                            <td>${item.userName}</td>
                            <td>${item.monthlyCount}</td>
                        </tr>
                    `);
                    $("#yearlyTable tbody").append(`
                        <tr>
                            <td>${item.userName}</td>
                            <td>${item.yearlyCount}</td>
                        </tr>
                    `);
                });

                // 排行榜 (依月出勤排序)
                data
                    .sort((a, b) => b.monthlyCount - a.monthlyCount)
                    .forEach((item, index) => {
                        const rankClass = index === 0 ? "rank-1"
                            : index === 1 ? "rank-2"
                            : index === 2 ? "rank-3"
                            : "";
                        $("#rankingList").append(`
                            <li class="list-group-item d-flex justify-content-between align-items-center ${rankClass}">
                                ${item.userName}
                                <span class="badge rounded-pill">${item.monthlyCount} 天</span>
                            </li>
                        `);
                    });

            } catch (error) {
                console.error("載入統計資料失敗：", error);
                $("#monthlyTable tbody").html(`<tr><td colspan='2' class='text-danger'>載入失敗</td></tr>`);
            }
        }
            $(document).on('show.bs.modal hidden.bs.modal', function () {
            document.body.style.paddingRight = '0px';
        });
    </script>
}