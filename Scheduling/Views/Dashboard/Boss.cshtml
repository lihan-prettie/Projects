@{
    ViewData["Title"] = "老闆登入";
}
@section Styles {
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <link rel="stylesheet" href="~/css/calendar-common.css" />
    <style>
        /* ===== Boss 統計資料區：橘黃色系 ===== */
        .stats-container {
            background-color: #fffaf0;
            border: 2px solid #ffd54f;
            border-radius: 15px;
            padding: 25px;
            margin-top: 40px;
            box-shadow: 0 0 12px rgba(255, 193, 7, 0.3);
        }

            .stats-container h4 {
                color: #b8860b;
                font-weight: 700;
                text-align: center;
                margin-bottom: 25px;
                letter-spacing: 1px;
            }

        .card {
            border-radius: 1rem;
            border: 2px solid #ffd54f;
            box-shadow: 0 4px 8px rgba(255, 165, 0, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

            .card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 16px rgba(255, 165, 0, 0.25);
            }

        .card-header {
            font-weight: bold;
            text-align: center;
            background: linear-gradient(90deg, #ffe082, #fbbf24);
            color: #5c3c00;
            border-bottom: none;
            letter-spacing: 1px;
        }

        .table {
            background-color: #fffdf6;
            border-color: #fcd34d;
        }

            .table th {
                background-color: #fff8dc;
                color: #8b6b00;
                font-weight: 600;
            }

            .table tbody tr:hover {
                background-color: #fff7e6;
            }

        #rankingList li {
            background-color: #fffaf0;
            border: 1px solid #fde68a;
            color: #92400e;
            font-weight: 500;
            transition: background-color 0.2s;
        }

            #rankingList li:hover {
                background-color: #fde68a;
            }

        #rankingList span.badge {
            background-color: #f59e0b !important;
        }

        /* 金牌前三名漸層效果 */
        .rank-1 {
            background: linear-gradient(90deg, #fff9c4, #fde68a);
        }

        .rank-2 {
            background: linear-gradient(90deg, #fff7ed, #ffecb3);
        }

        .rank-3 {
            background: linear-gradient(90deg, #fffaf0, #fff59d);
        }
    </style>
}

<div id="calendar"></div>

<!-- 🧮 統計資料區 -->
<div class="container stats-container">
    <h4>員工出勤統計</h4>
    <div class="row">
        <!-- 該月統計 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">本月上班天數</div>
                <div class="card-body">
                    <table class="table table-sm table-bordered text-center" id="monthlyTable">
                        <thead>
                            <tr>
                                <th>員工姓名</th>
                                <th>天數</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 該年統計 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">年度上班天數</div>
                <div class="card-body">
                    <table class="table table-sm table-bordered text-center" id="yearlyTable">
                        <thead>
                            <tr>
                                <th>員工姓名</th>
                                <th>天數</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 排行榜 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">本月上班排行榜 🏆</div>
                <div class="card-body">
                    <ol id="rankingList" class="list-group list-group-numbered"></ol>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/calendar-common.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            initScheduleCalendar("calendar", 1); // 1 = boss

            // 🧮 載入統計資料
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            await loadStatistics(year, month);
        });

        async function loadStatistics(year, month) {
            try {
                const res = await fetch(`/Boss/GetMonthlyStats?year=${year}&month=${month}`);
                if (!res.ok) throw new Error("載入統計資料失敗");
                const data = await res.json();

                // 清空舊內容
                $("#monthlyTable tbody").empty();
                $("#yearlyTable tbody").empty();
                $("#rankingList").empty();

                // 依據資料填入表格
                data.forEach(item => {
                    const name = item.userName || "未指派";

                    $("#monthlyTable tbody").append(`
                        <tr><td>${name}</td><td>${item.monthlyCount}</td></tr>
                    `);

                    $("#yearlyTable tbody").append(`
                        <tr><td>${name}</td><td>${item.yearlyCount}</td></tr>
                    `);
                });

                // 排行榜（依月天數降冪）
                data.sort((a, b) => b.monthlyCount - a.monthlyCount)
                    .forEach((item, idx) => {
                        const medal = idx === 0 ? "🥇" : idx === 1 ? "🥈" : idx === 2 ? "🥉" : "";
                        const rankClass = idx === 0 ? "rank-1" : idx === 1 ? "rank-2" : idx === 2 ? "rank-3" : "";
                        $("#rankingList").append(`
                            <li class="list-group-item d-flex justify-content-between align-items-center ${rankClass}">
                                ${medal} ${item.userName || "未指派"}
                                <span class="badge bg-secondary rounded-pill">${item.monthlyCount}天</span>
                            </li>
                        `);
                    });
            } catch (err) {
                console.error(err);
                Swal.fire("載入失敗", "無法載入統計資料", "error");
            }
        }
    </script>
}
