@{
    ViewData["Title"] = "老闆登入";
}
@section Styles {
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <link rel="stylesheet" href="~/css/calendar-common.css" />
    <style>
        /* ===== Boss 統計資料區：橘黃色系 ===== */
        .stats-container {
            background-color: #fffaf0;
            border: 2px solid #ffd54f;
            border-radius: 15px;
            padding: 25px;
            margin-top: 40px;
            box-shadow: 0 0 12px rgba(255, 193, 7, 0.3);
        }

            .stats-container h4 {
                color: #b8860b;
                font-weight: 700;
                text-align: center;
                margin-bottom: 25px;
                letter-spacing: 1px;
            }

        .card {
            border-radius: 1rem;
            border: 2px solid #ffd54f;
            box-shadow: 0 4px 8px rgba(255, 165, 0, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

            .card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 16px rgba(255, 165, 0, 0.25);
            }

        .card-header {
            font-weight: bold;
            text-align: center;
            background: linear-gradient(90deg, #ffe082, #fbbf24);
            color: #5c3c00;
            border-bottom: none;
            letter-spacing: 1px;
        }

        .table {
            background-color: #fffdf6;
            border-color: #fcd34d;
        }

            .table th {
                background-color: #fff8dc;
                color: #8b6b00;
                font-weight: 600;
            }

            .table tbody tr:hover {
                background-color: #fff7e6;
            }

        #rankingList li {
            background-color: #fffaf0;
            border: 1px solid #fde68a;
            color: #92400e;
            font-weight: 500;
            transition: background-color 0.2s;
        }

            #rankingList li:hover {
                background-color: #fde68a;
            }

        #rankingList span.badge {
            background-color: #f59e0b !important;
        }

        /* 金牌前三名漸層效果 */
        .rank-1 {
            background: linear-gradient(90deg, #fff9c4, #fde68a);
        }

        .rank-2 {
            background: linear-gradient(90deg, #fff7ed, #ffecb3);
        }

        .rank-3 {
            background: linear-gradient(90deg, #fffaf0, #fff59d);
        }
    </style>
}

<div id="calendar"></div>

<!-- 🧮 統計資料區 -->
<div class="container stats-container">
    <h4>員工出勤統計</h4>
    <div class="row">
        <!-- 該月統計 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">本月上班天數</div>
                <div class="card-body">
                    <table class="table table-sm table-bordered text-center" id="monthlyTable">
                        <thead>
                            <tr>
                                <th>員工姓名</th>
                                <th>天數</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 該年統計 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">年度上班天數</div>
                <div class="card-body">
                    <table class="table table-sm table-bordered text-center" id="yearlyTable">
                        <thead>
                            <tr>
                                <th>員工姓名</th>
                                <th>天數</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 排行榜 -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">本月上班排行榜</div>
                <div class="card-body">
                    <ol id="rankingList" class="list-group list-group-numbered"></ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🧭 操作按鈕 -->
<div class="d-flex justify-content-end mb-3">
    <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#addTripModal">
        <i class="bi bi-briefcase-fill"></i> 新增出差工作
    </button>
    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editRoleModal">
        <i class="bi bi-person-gear"></i> 管理員工角色
    </button>
</div>

<!-- 🚗 新增出差工作 + 排班 -->
<div class="modal fade" id="addTripModal" tabindex="-1" aria-labelledby="addTripModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="addTripModalLabel"><i class="bi bi-briefcase-fill"></i> 新增出差工作與排班</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label>出差名稱：</label>
                        <input type="text" id="tripName" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label>出差地點：</label>
                        <input type="text" id="tripLocation" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label>出差日期：</label>
                        <input type="date" id="tripDate" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label>開始時間：</label>
                        <input type="time" id="tripStart" class="form-control" value="09:00">
                    </div>
                    <div class="col-md-4">
                        <label>結束時間：</label>
                        <input type="time" id="tripEnd" class="form-control" value="18:00">
                    </div>
                    <div class="col-12">
                        <label>備註：</label>
                        <textarea id="tripNote" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-warning" onclick="submitBusinessTrip()">新增</button>
            </div>
        </div>
    </div>
</div>


<!-- 👥 修改角色 Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-labelledby="editRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="editRoleModalLabel"><i class="bi bi-person-gear"></i> 修改員工角色</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <select id="userSelect" class="form-select mb-3"></select>
                <select id="roleSelect" class="form-select">
                    <option value="1">老闆</option>
                    <option value="2">主管</option>
                    <option value="3">員工</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-warning" onclick="updateUserRole()">更新</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/calendar-common.js"></script>

    <script>
                document.addEventListener("DOMContentLoaded", async () => {
            const calendar = await initScheduleCalendar("calendar", 1); // 老闆
            loadUserList();

            const today = new Date();
            await loadStatistics(today.getFullYear(), today.getMonth() + 1);

            // 📅 切換月份時重新載入統計
            calendar.on('datesSet', async (info) => {
                const viewDate = info.view.currentStart;
                await loadStatistics(viewDate.getFullYear(), viewDate.getMonth() + 1);
            });
        });


                async function submitBusinessTrip() {
            const name = $("#tripName").val().trim();
            const loc = $("#tripLocation").val().trim();
            const date = $("#tripDate").val();
            const start = $("#tripStart").val();
            const end = $("#tripEnd").val();
            const note = $("#tripNote").val();

            if (!name || !date) {
                Swal.fire("請填寫完整資料", "出差名稱與日期為必填", "warning");
                return;
            }

            const startTime = new Date(`${date}T${start}`);
            const endTime = new Date(`${date}T${end}`);

            const res = await fetch(`/api/ScheduleApi/AddBusinessTrip`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    WorkName: name,
                    WorkLocation: loc,
                    WorkNote: note,
                    StartTime: startTime,
                    EndTime: endTime
                })
            });

            const data = await res.json();
            if (data.success) {
            Swal.fire("成功", data.message, "success");
            $("#addTripModal").modal("hide");
            calendar.refetchEvents();

            // 📊 重新載入統計資料
            const date = new Date($("#tripDate").val());
            await loadStatistics(date.getFullYear(), date.getMonth() + 1);
        }

        }


        async function loadUserList() {
            const res = await fetch(`/Boss/GetAllUsers`);
            const users = await res.json();
            $("#userSelect").empty();
            users.forEach(u => {
                $("#userSelect").append(`<option value="${u.userId}">${u.userName} (目前角色：${u.roleId})</option>`);
            });
        }

        async function updateUserRole() {
            const userId = $("#userSelect").val();
            const roleId = $("#roleSelect").val();

            const res = await fetch(`/Boss/UpdateUserRole`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ UserId: parseInt(userId), RoleId: parseInt(roleId) })
            });
            const data = await res.json();
            if (data.success) {
                Swal.fire("成功", data.message, "success");
                $("#editRoleModal").modal("hide");
            } else {
                Swal.fire("錯誤", data.message, "error");
            }
        }

                    async function loadStatistics(year, month) {
            try {
                const res = await fetch(`/Boss/GetMonthlyStats?year=${year}&month=${month}`);
                const data = await res.json();

                // 清空舊資料
                $("#monthlyTable tbody").empty();
                $("#yearlyTable tbody").empty();
                $("#rankingList").empty();

                if (!data || data.length === 0) {
                    $("#monthlyTable tbody").append(`<tr><td colspan='2'>無資料</td></tr>`);
                    $("#yearlyTable tbody").append(`<tr><td colspan='2'>無資料</td></tr>`);
                    $("#rankingList").append(`<li class="list-group-item">無資料</li>`);
                    return;
                }

                // 本月與本年統計表格
                data.forEach(item => {
                    $("#monthlyTable tbody").append(`
                        <tr>
                            <td>${item.userName}</td>
                            <td>${item.monthlyCount}</td>
                        </tr>
                    `);
                    $("#yearlyTable tbody").append(`
                        <tr>
                            <td>${item.userName}</td>
                            <td>${item.yearlyCount}</td>
                        </tr>
                    `);
                });

                // 排行榜 (依月出勤排序)
                data
                    .sort((a, b) => b.monthlyCount - a.monthlyCount)
                    .forEach((item, index) => {
                        const rankClass = index === 0 ? "rank-1"
                            : index === 1 ? "rank-2"
                            : index === 2 ? "rank-3"
                            : "";
                        $("#rankingList").append(`
                            <li class="list-group-item d-flex justify-content-between align-items-center ${rankClass}">
                                ${item.userName}
                                <span class="badge rounded-pill">${item.monthlyCount} 天</span>
                            </li>
                        `);
                    });

            } catch (error) {
                console.error("載入統計資料失敗：", error);
                $("#monthlyTable tbody").html(`<tr><td colspan='2' class='text-danger'>載入失敗</td></tr>`);
            }
        }

    </script>
}
