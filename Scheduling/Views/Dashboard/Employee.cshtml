@{
    ViewData["Title"] = "一般員工登入";
}

@section Styles {
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <style>
        /* ===== 整體背景與日曆外觀 ===== */
        body {
            background-color: #fff8dc; /* 柔和黃色背景 */
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        #calendar {
            background-color: #fff; /* 日曆白底 */
            border: 3px solid #ffd700; /* 金黃色邊框 */
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(255, 165, 0, 0.2);
            max-width: 90%;
            margin: 30px auto;
        }

        /* ===== 星期與日期顏色 ===== */
        .fc-col-header-cell-cushion,
        .fc-daygrid-day-number {
            color: #b8860b !important; /* 土黃色 */
            font-weight: 600;
        }

        /* 日期 hover 效果 */
        .fc-daygrid-day:hover {
            background-color: #ffa50033 !important; /* 淡橘色 */
            cursor: pointer;
        }

        /* 今日日期 */
        .fc-day-today {
            background-color: #ffcc80 !important; /* 橘黃底 */
            border: 2px solid #ffa500 !important;
            color: #b8860b !important;
        }

        /* 週末背景色 */
        .fc-day-sat,
        .fc-day-sun {
            background-color: #fffacd !important; /* 淺黃色 */
        }

        /* ===== 按鈕樣式 ===== */
        .fc-button {
            background-color: #ffeb3b !important; /* 亮黃 */
            color: #b8860b !important; /* 土黃字 */
            border: 1px solid #ffd700 !important;
            font-weight: 600;
            transition: 0.2s;
        }

            .fc-button:hover {
                background-color: #ffc107 !important; /* 深橘黃 */
                color: #fff8dc !important; /* 字變亮 */
            }

        /* 月份與年份置中 */
        .fc-toolbar-title {
            color: #b8860b;
            font-size: 1.6rem;
            font-weight: 700;
            text-align: center;
            flex: 1;
        }

        /* 工具列置中排列 */
        .fc-toolbar-chunk {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
}

<div id="calendar"></div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const calendarEl = document.getElementById("calendar");

            // 🧭 當前年月
            const today = new Date();
            const currentYear = today.getFullYear();
            const nextYear = today.getFullYear()+1;
            const nextMonth = today.getMonth() + 1; // 0-based index
            const nextMonthYear = today.getFullYear() + Math.floor(nextMonth / 12);

            // 🧩 同時載入節日資料
            const [data1, data2] = await Promise.all([
                fetch(`/api/Holiday/${currentYear}`).then(res => res.json()),
                fetch(`/api/Holiday/${nextYear}`).then(res => res.json())
            ]);
            const data = [...data1, ...data2];

            // 🗓️ 建立 FullCalendar
            const calendar = new FullCalendar.Calendar(calendarEl, {
                themeSystem: "bootstrap5",
                locale: "zh-tw",
                initialView: "dayGridMonth",
                selectable: true,

                headerToolbar: {
                    left: "prev today next",
                    center: "title",
                    right: "dayGridMonth,list"
                },
                buttonText: { today: "今天" },

                // ✅ 限制：僅允許選取 / 新增下個月的日期
                selectAllow: (selectInfo) => {
                    const start = selectInfo.start;
                    return start.getMonth() === nextMonth % 12 && start.getFullYear() === nextMonthYear;
                },

                // ✅ 點擊日期時檢查月份
                dateClick: (info) => {
                    const d = info.date;
                    if (d.getMonth() === nextMonth % 12 && d.getFullYear() === nextMonthYear) {
                        Swal.fire({
                            title: "新增工作",
                            text: "這是下個月的日期，可以新增工作！",
                            icon: "success",
                            confirmButtonText: "確認"
                        });
                    } else {
                        Swal.fire({
                            title: "無法新增工作",
                            text: "只能新增下一個月工作",
                            icon: "warning",
                            confirmButtonText: "確認"
                        });
                    }
                },

                // 🎨 標示節日
                dayCellDidMount: (info) => {
                    const date = new Date(info.date.getTime() - info.date.getTimezoneOffset() * 60000);
                    const dateStr = date.toISOString().slice(0, 10).replace(/-/g, "");

                    const holiday = data.find(h => h["西元日期"] === dateStr);

                    // 清除舊樣式
                    info.el.style.backgroundColor = "";
                    info.el.style.color = "#000";

                    if (holiday && holiday["是否放假"] === "2") {
                        // 顏色設定
                        if (holiday["星期"] === "六" || holiday["星期"] === "日") {
                            info.el.style.backgroundColor = "#fffacd"; // 淺黃 (週末)
                        } else {
                            info.el.style.backgroundColor = "#ffe4b5"; // 淺橘 (平日節日)
                        }

                        // 顯示備註
                        if (holiday["備註"]) {
                            const remarkEl = document.createElement("div");
                            remarkEl.textContent = holiday["備註"];
                            remarkEl.style.fontSize = "1rem";
                            remarkEl.style.color = "#b8860b";
                            remarkEl.style.fontWeight = "600";
                            remarkEl.style.position = "absolute";
                            remarkEl.style.pointerEvents = "none";
                            remarkEl.style.whiteSpace = "nowrap";
                            const frame = info.el.querySelector(".fc-daygrid-day-frame");
                            frame.style.position = "relative";
                            frame.appendChild(remarkEl);
                        }
                    }
                }
            });

            calendar.render();
        });
    </script>
}


