@{
    ViewData["Title"] = "註冊帳號";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body {
            background: linear-gradient(180deg, #fff8dc 0%, #fff 100%);
            font-family: "Microsoft JhengHei", sans-serif;
        }

        .register-box {
            background-color: #fffdf5;
            border: 2px solid #ffd54f;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
            max-width: 450px;
            margin: 80px auto;
            padding: 40px 35px;
        }

        .register-box h1 {
            text-align: center;
            font-weight: 800;
            color: #b8860b;
            margin-bottom: 30px;
        }

        .form-label {
            font-weight: 600;
            color: #8b6b00;
        }

        .form-control {
            border-radius: 10px;
            border: 1px solid #ffd54f;
            transition: all 0.3s ease-in-out;
        }

        .form-control:focus {
            border-color: #ffa500;
            box-shadow: 0 0 6px rgba(255, 165, 0, 0.5);
        }

        .btn-main {
            background-color: #ffa500;
            color: #fff8dc;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-main:hover {
            background-color: #ffb74d;
            color: #fff;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }

        .alert-text {
            display: none;
            color: red;
            font-size: 0.9rem;
            margin-top: 2px;
        }

        .is-invalid {
            border-color: red !important;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #b8860b;
            font-weight: 600;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
            color: #ff9800;
        }
    </style>
}

<div class="register-box">
    <h1><i class="bi bi-person-plus-fill me-2"></i>註冊帳號</h1>

    <div class="mb-3">
        <label class="form-label">使用者名稱</label>
        <input type="text" name="name" id="name" class="form-control" />
        <div id="nameError" class="alert-text">必填欄位未填寫</div>
    </div>

    <div class="mb-3">
        <label class="form-label">電子信箱</label>
        <input type="email" placeholder="xx@mail.com" id="email" class="form-control" name="email" />
        <div id="emailError" class="alert-text">必填欄位未填寫</div>
    </div>

    <div class="mb-3">
        <label class="form-label">密碼</label>
        <input type="password" id="password" class="form-control" name="password" />
        <div id="passwordError" class="alert-text">必填欄位未填寫</div>
    </div>

    <div class="mb-3">
        <label class="form-label">確認密碼</label>
        <input type="password" id="checkPassword" class="form-control" />
        <div id="pswError" class="alert-text">密碼與確認密碼不一致</div>
    </div>

    <button id="confirm" class="btn btn-main" disabled>
        <i class="bi bi-check-circle me-1"></i>確認註冊
    </button>

    <a href="/Login/Index" class="back-link">
        <i class="bi bi-arrow-left-circle"></i> 返回登入頁
    </a>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let emailValid = false;
        const passwordPattern = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[^\w\s]).{8,}$/;

        function checkFormValid() {
            const name = $("#name").val().trim();
            const email = $("#email").val().trim();
            const password = $("#password").val().trim();
            const checkPassword = $("#checkPassword").val().trim();
            const passwordsafe = passwordPattern.test(password);
            const allFilled = name && email && password && checkPassword;
            const pswValid = password === checkPassword;
            const valid = allFilled && pswValid && emailValid && passwordsafe;
            $("#confirm").prop("disabled", !valid);
        }

        $("#name,#email,#password,#checkPassword").on("input", () => {
            $(".alert-text").hide();
            $("input").removeClass("is-invalid");
            checkFormValid();
        });

        $("#name,#email,#password").on("blur", () => {
            const name = $("#name").val().trim();
            if (!name) { $("#nameError").show(); $("#name").addClass("is-invalid"); }
            checkFormValid();
        });

        $("#password,#checkPassword").on("input", () => {
            const password = $("#password").val().trim();
            const checkPassword = $("#checkPassword").val().trim();
            if (password && checkPassword && password !== checkPassword) {
                $("#pswError").show();
                $("#checkPassword").addClass("is-invalid");
            } else {
                $("#pswError").hide();
                $("#checkPassword").removeClass("is-invalid");
            }
            checkFormValid();
        });

        $("#email").on("blur", () => {
            const email = $("#email").val().trim().toLowerCase();
            if (!email) { $("#emailError").show(); $("#email").addClass("is-invalid"); return; }

            const emailPattern = /^[^\\s@@]+@@[^\\s@@]+\\.[^\\s@@]+$/;
            if (!emailPattern.test(email)) {
                $("#emailError").text("Email 格式不正確").show();
                $("#email").addClass("is-invalid");
                emailValid = false;
                checkFormValid();
                return;
            }

            $.ajax({
                type: "POST",
                url: "/Signup/EmailCheck",
                data: { email: email },
                success: (res) => {
                    if (res.exists) {
                        $("#emailError").text("電子信箱已被註冊").show();
                        $("#email").addClass("is-invalid");
                        emailValid = false;
                    } else {
                        $("#emailError").hide();
                        $("#email").removeClass("is-invalid");
                        emailValid = true;
                    }
                    checkFormValid();
                },
                error: () => {
                    $("#emailError").text("無法驗證電子信箱").show();
                    $("#email").addClass("is-invalid");
                    emailValid = false;
                    checkFormValid();
                },
            });
        });

        $("#password").on("blur", () => {
            const password = $("#password").val().trim();
            if (!passwordPattern.test(password)) {
                $("#passwordError").text("密碼至少8碼，需含大小寫字母、數字與特殊符號").show();
                $("#password").addClass("is-invalid");
            } else {
                $("#passwordError").hide();
                $("#password").removeClass("is-invalid");
            }
            checkFormValid();
        });

        $("#confirm").on("click", () => {
            const name = $("#name").val().trim();
            const email = $("#email").val().trim();
            const password = $("#password").val().trim();
            const checkPassword = $("#checkPassword").val().trim();

            $.ajax({
                type: "POST",
                url: "/Signup/Signup",
                data: { UserName: name, UserEmail: email, UserPassword: password, ConfirmPassword: checkPassword },
                success: (res) => {
                    if (res.success) {
                        Swal.fire({
                            title: "註冊成功",
                            text: "請使用您的帳號登入系統。",
                            icon: "success",
                            confirmButtonText: "前往登入"
                        }).then(() => {
                            window.location.href = "/Login/Index";
                        });
                    } else {
                        Swal.fire("註冊失敗", res.message, "error");
                    }
                }
            });
        });
    </script>
}
