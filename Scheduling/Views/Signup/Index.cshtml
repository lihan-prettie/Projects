@{
    ViewData["Title"] = "註冊帳號";
}
@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        input {
            margin-bottom: 10px;
            padding: 5px;
            width: 250px;
        }

        button {
            padding: 6px 15px;
            cursor: pointer;
        }

        .is-invalid {
            border: 1px solid red;
        }
    </style>
}
<h1>註冊帳號</h1>

<h3>使用者名稱:</h3>
<input type="text" name="name" id="name" class="form-control" />
<span style="display:none;color:red;" id="nameError">必填欄位未填寫</span>

<h3>電子信箱:</h3>
<input type="email" placeholder="xx@mail.com" id="email" class="form-control" name="email" />
<span style="display:none;color:red;" id="emailError">必填欄位未填寫</span>

<h3>密碼:</h3>
<input type="password" id="password" class="form-control" name="password"/>
<span style="display:none;color:red;" id="passwordError">必填欄位未填寫</span>
<span style="display:none;color:red;" id="pswError">密碼與確認密碼不一致</span>

<h3>確認密碼:</h3>
<input type="password" id="checkPassword" class="form-control" />

<button id="confirm" class="btn btn-outline-warning" disabled>確認註冊</button>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let emailValid = false;
        const passwordPattern = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[^\w\s]).{8,}$/;

        // ✅ 統一驗證函式：控制按鈕啟用
        function checkFormValid() {
            const name = $("#name").val().trim();
            const email = $("#email").val().trim();
            const password = $("#password").val().trim();
            const checkPassword = $("#checkPassword").val().trim();
            const passwordsafe = passwordPattern.test(password);
            const allFilled = name && email && password && checkPassword;
            const pswValid = password === checkPassword;
            const valid = allFilled && pswValid && emailValid&&passwordsafe;
            $("#confirm").prop("disabled", !valid);
        }

        // ✅ 即時輸入時隱藏錯誤 & 檢查
        $("#name,#email,#password,#checkPassword").on("input", () => {
            $("#nameError, #emailError, #passwordError, #pswError").hide();
            $("input").removeClass("is-invalid");
            checkFormValid();
        });

        // ✅ blur 時檢查是否空白
        $("#name,#email,#password").on("blur", () => {
            const name = $("#name").val().trim();
            if (!name) { $("#nameError").show(); $("#name").addClass("is-invalid"); }
            checkFormValid();
        });

        // ✅ 即時檢查密碼一致性
        $("#password,#checkPassword").on("input", () => {
            const password = $("#password").val().trim();
            const checkPassword = $("#checkPassword").val().trim();
            if (password && checkPassword && password !== checkPassword) {
                $("#pswError").show();
                $("#checkPassword").addClass("is-invalid");
            } else {
                $("#pswError").hide();
                $("#checkPassword").removeClass("is-invalid");
            }
            checkFormValid();
        });

        // ✅ Email 檢查（含格式與重複）
        $("#email").on("blur", () => {
            const email = $("#email").val().trim().toLowerCase();
            if (!email) { $("#emailError").show(); $("#email").addClass("is-invalid"); return}
            // 格式檢查
            const emailPattern = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
            if (!emailPattern.test(email)) {
                $("#emailError").text("Email 格式不正確").show();
                $("#email").addClass("is-invalid");
                emailValid = false;
                checkFormValid();
                return;
            }

            // Ajax 驗證
            $.ajax({
                type: "POST",
                url: "/Signup/EmailCheck",
                data: { email: email },
                success: (res) => {
                    if (res.exists) {
                        $("#emailError").text("電子信箱已被註冊").show();
                        $("#email").addClass("is-invalid");
                        emailValid = false;
                    } else {
                        $("#emailError").hide();
                        $("#email").removeClass("is-invalid");
                        emailValid = true;
                    }
                    checkFormValid();
                },
                error: () => {
                    $("#emailError").text("無法驗證電子信箱").show();
                    $("#email").addClass("is-invalid");
                    emailValid = false;
                    checkFormValid();
                },
            });
        });

        $("#password").on("blur",()=>{
            const password = $("#password").val().trim();
            

            if(!passwordPattern.test(password)){
                $("#passwordError").text("密碼長度至少8碼，且必須含英文大小寫、阿拉伯數字和特殊符號").show(); 
                $("#password").addClass("is-invalid");
            }else{
                $("#passwordError").hide();
                $("#password").removeClass("is-invalid");
            }
            checkFormValid();
        });

        $("#confirm").on("click",()=>{
            const name = $("#name").val().trim();
            const email = $("#email").val().trim();
            const password = $("#password").val().trim();
            const checkPassword = $("#checkPassword").val().trim();
            $.ajax({
                type:"POST",
                url:"/Signup/Signup",
                data:{UserName:name,UserEmail:email,UserPassword:password,ConfirmPassword:checkPassword},
                success:(res)=>{
                    if(res.success){
                        Swal.fire({
                        title: "註冊成功",
                        text: "",
                        icon: "success",
                        showConfirmButton: true,
                    }).then(() => {
                        $("#name, #email, #password, #checkPassword").val("");
                        window.location.href = "/Login/Index";
                    });
                    }else{
                        Swal.fire("註冊失敗",res.message,"error");
                    }
                },
                error:()=>{},
            });
        })
    </script>
}
