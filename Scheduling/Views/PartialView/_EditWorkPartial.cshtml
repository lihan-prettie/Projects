@model Scheduling.Models.ViewModels.EditScheduleViewModel

<style>
    .readonly-box input, .readonly-box textarea {
        background-color: #f8f9fa !important;
    }
</style>

<div class="modal-header bg-warning text-dark">
    <h5 class="modal-title">班表資訊</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body readonly-box">
    @{
        var count = ViewData["ShiftCount"] is int c ? c : 0;
        var remainMin = Math.Max(0, 6 - count); // 還差幾班達到 6
                                                // remainMax 可不用顯示，但保留在需要時使用
    }

    <div class="alert @(count >= 15 ? "alert-danger" : count < 6 ? "alert-warning" : "alert-success") text-center py-2 mb-3">
        本月已排 <strong>@count</strong> 班，
        最少需排 6 班、最多 15 班。
        您還差 <strong>@remainMin</strong> 班即可達到最低標準。
    </div>

    <input type="hidden" id="originalUserId" value="@(ViewData["OriginalUserId"]?.ToString() ?? "")" />

    <form id="editScheduleForm">
        <input type="hidden" name="ScheduleId" value="@Model.ScheduleId" />

        <div class="mb-3">
            <label class="form-label fw-bold">工作名稱</label>
            <input class="form-control" value="@Model.WorkName" readonly />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">日期</label>
            <input class="form-control" value="@Model.ScheduleDate" readonly />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">時間</label>
            <input class="form-control" value="@Model.StartTime ~ @Model.EndTime" readonly />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold text-secondary">工作地點</label>
            <input type="text" id="workLocation" name="WorkLocation" class="form-control"
                   value="@Model.WorkLocation" oninput="updateMapPreview()" />
        </div>
        <!-- 🗺️ Google Map 預覽 -->
        <div id="mapPreviewContainer" class="mt-3" style="display:none;">
            <iframe id="mapPreview"
                    width="100%"
                    height="300"
                    style="border:0; border-radius:10px;"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade">
            </iframe>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">備註</label>
            <textarea class="form-control" rows="2" readonly>@Model.WorkNote</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">狀態</label>
            <input class="form-control" value="@Model.Status" readonly />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">使用者編號 (UserId)</label>
            <input type="text" class="form-control" name="UserId" value="@Model.UserId" />
        </div>

        @if (Model.IsEditable)
        {
            <div class="d-flex justify-content-end">
                <button type="button" id="releaseBtn" class="btn btn-outline-danger me-2">釋出班表</button>
                <button type="submit" class="btn btn-warning me-2">儲存</button>
                <button type="button" id="cancelBtn" class="btn btn-secondary">離開</button>
            </div>
        }
        else
        {
            <div class="text-center text-muted fw-bold">此班已被他人預定，僅供查看</div>
            <div class="d-flex justify-content-end mt-3">
                <button type="button" id="cancelBtn" class="btn btn-secondary">離開</button>
            </div>
        }
    </form>
</div>
<script>
    // ✅ 避免重複宣告（Partial 會多次載入）
    if (typeof currentUserId === "undefined") {
        var currentUserId = parseInt('@(Context.Session.GetInt32("UserId") ?? 0)');
    }

    $(function () {
        const $userInput = $("input[name='UserId']");
        const originalRaw = $("#originalUserId").val(); // 可能 "", "null", "4"
        const originalUserId = (!originalRaw || originalRaw === "null") ? null : parseInt(originalRaw);

        // ✅ 按鈕狀態只看「資料表原始 UserId」
        if (originalUserId === null) {
            $("#releaseBtn").prop("disabled", true);  // 無人佔用 → 不能釋出
        } else {
            $("#releaseBtn").prop("disabled", false); // 有人佔用（可能是自己）→ 可釋出
        }

        // 下面這段是 UX：空班畫面自動代入登入者，方便「搶班」
        let userIdVal = $userInput.val();  // 可能 "", "null", "4"
        const normalized = (userIdVal === "" || userIdVal === "null") ? null : parseInt(userIdVal);
        if (normalized === null) {
            $userInput.val(currentUserId);
        }

        // 他人班 → 鎖表單（但仍可關閉）
        if (originalUserId !== null && originalUserId !== currentUserId) {
            $("#editScheduleForm :input").prop("disabled", true);
            $("#cancelBtn").prop("disabled", false);
        }
    });

    // 釋出：送 0（後端會把 0 → null）
    $("#releaseBtn").on("click", function () {
        $("input[name='UserId']").val(0);
        $("#editScheduleForm").submit();
    });

    // 儲存（搶班 / 釋出 / 維持）
    $("#editScheduleForm").on("submit", function (e) {
        e.preventDefault();
        this.UserId.value = $("input[name='UserId']").val().trim();
        $.post("/Schedule/UpdateSchedule", $(this).serialize(), function (res) {
            Swal.fire(res.success ? "成功" : "錯誤", res.message, res.success ? "success" : "error")
              .then(() => {
                  $("#addWorkModal").modal("hide");
                  calendar.refetchEvents();
              });
        });
    });

    $("#cancelBtn").on("click", function () {
        $("#addWorkModal").modal("hide");
    });

    function updateMapPreview() {
        const location = document.getElementById("workLocation").value.trim();
        const mapContainer = document.getElementById("mapPreviewContainer");
        const iframe = document.getElementById("mapPreview");

        if (location) {
            const encoded = encodeURIComponent(location);
            iframe.src = `https://www.google.com/maps?q=${encoded}&output=embed`;
            mapContainer.style.display = "block";
        } else {
            mapContainer.style.display = "none";
            iframe.src = "";
        }
    }

    // ✅ 若有預設地點，初次載入就顯示地圖
    document.addEventListener("DOMContentLoaded", () => {
        const initLoc = document.getElementById("workLocation")?.value.trim();
        if (initLoc) updateMapPreview();
    });

</script>


