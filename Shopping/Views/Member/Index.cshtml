@{
    ViewData["Title"] = "登入/註冊";
}
@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        .form-container {
            max-width: 500px;
            margin: 2rem auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .btn-group {
            max-width: 500px;
            margin: 2rem auto 0;
            display: flex;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .btn-check:checked + .btn-outline-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            margin-top: 0.5rem;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
    </style>
}

<div class="container-fluid px-4 py-5">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary mb-2">
            <i class="bi bi-person-circle me-2"></i>會員專區
        </h2>
        <p class="text-muted">登入或註冊以開始購物</p>
    </div>

    <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
        <input type="radio" class="btn-check" name="btnradio" id="btnLogin" autocomplete="off" checked>
        <label class="btn btn-outline-success fw-bold" for="btnLogin">
            <i class="bi bi-box-arrow-in-right me-2"></i>登入
        </label>
        <input type="radio" class="btn-check" name="btnradio" id="btnSignup" autocomplete="off">
        <label class="btn btn-outline-success fw-bold" for="btnSignup">
            <i class="bi bi-person-plus me-2"></i>註冊
        </label>
    </div>

@* 登入表單 *@
<div id="Login" class="form-container">
    <h3 class="text-success mb-4 text-center">
        <i class="bi bi-box-arrow-in-right me-2"></i><strong>登入會員</strong>
    </h3>
    <form novalidate>
        <div class="mb-4">
            <label class="text-success fw-semibold mb-2 d-block">
                <i class="bi bi-envelope me-1"></i>電子郵件
            </label>
            <input type="text" name="Email" id="LoginEmail" placeholder="請輸入您的電子郵件" required />
        </div>
        <div class="mb-4">
            <label class="text-success fw-semibold mb-2 d-block">
                <i class="bi bi-lock me-1"></i>密碼
            </label>
            <input type="password" name="Password" id="LoginPsw" placeholder="請輸入您的密碼" required />
        </div>
        <div class="d-grid">
            <button class="btn btn-success btn-lg fw-bold" type="button" id="LoginBtn" disabled>
                <i class="bi bi-box-arrow-in-right me-2"></i>登入
            </button>
        </div>
    </form>
</div>

@* 註冊表單 *@
<div id="Signup" class="form-container d-none">
    <h3 class="text-success mb-4 text-center">
        <i class="bi bi-person-plus me-2"></i><strong>註冊會員</strong>
    </h3>
    <form>
        <div class="mb-3">
            <label class="text-success fw-semibold mb-2 d-block">
                <i class="bi bi-person me-1"></i>使用者名稱
            </label>
            <input type="text" name="name" placeholder="請輸入您的名稱" id="name" required />
            <div id="nameWarn" class="text-danger small mt-1">名稱未填寫</div>
        </div>
        <div class="mb-3">
            <label class="text-success fw-semibold mb-2 d-block">
                <i class="bi bi-envelope me-1"></i>電子郵件
            </label>
            <input type="email" name="SignupAccount" placeholder="請輸入您的電子郵件" id="SignupEmail" required />
            <div id="emailWarn" class="text-danger small mt-1"></div>
        </div>
        <div class="mb-3">
            <label class="text-success fw-semibold mb-2 d-block">
                <i class="bi bi-lock me-1"></i>密碼
            </label>
            <input type="password" name="SignupPassword" placeholder="請輸入密碼（8-15字元，包含大小寫、數字、特殊字元）" id="SignupPsw" required />
            <div id="passwordWarn" class="text-danger small mt-1"></div>
        </div>
        <div class="mb-4">
            <label class="text-success fw-semibold mb-2 d-block">
                <i class="bi bi-lock-fill me-1"></i>確認密碼
            </label>
            <input type="password" name="SignupPasswordConfirmed" placeholder="請再次輸入密碼" id="CheckPsw" required />
            <div id="pswWarn" class="text-danger small mt-1"></div>
        </div>
        <div class="d-grid">
            <button class="btn btn-success btn-lg fw-bold" type="button" id="SignupBtn" disabled>
                <i class="bi bi-person-plus me-2"></i>註冊
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        $(document).ready(function () {
            $(".text-danger").hide();

            //改變視窗顯示(註冊or登入)
            $("#btnLogin").on("click", () => {
                $("#Signup").addClass("d-none");
                $("#Login").removeClass("d-none");
            });
            
            $("#btnSignup").on("click", () => {
                $("#Login").addClass("d-none");
                $("#Signup").removeClass("d-none");
            });

            //設定電子郵件檢查用變數和密碼模板
            let emailValid = false;
            const passwordPattern = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[^\w\s]).{8,15}$/;

            //登入函式
            async function login(email,password){
                const res = await authFetch("/api/members/login",{
                    method:"post",
                    body:JSON.stringify({email,password})
                });

                const data = await res.json();

                if(!res.ok){
                    throw new Error( data.message||"登入失敗" )
                }
                 setToken(data.token);
                 return data;
            }

            //註冊函式
            async function signup(name,email,password){
                const res = await authFetch("/api/members/signup",{
                    method:"post",
                    body: JSON.stringify({
                        UserName:name,
                        email,
                        password
                    })
                });

                const data = await res.json();
                if(!res.ok){
                    throw new Error(data.message || "註冊失敗");
                }
                return data;
            }

            //確認所有欄位是否填寫完整
            function SignupFormValid() {
                const name = $("#name").val().trim();
                const SignupEmail = $("#SignupEmail").val().trim();
                const SignupPsw = $("#SignupPsw").val().trim();
                const CheckPsw = $("#CheckPsw").val().trim();

                const passwordCheck = passwordPattern.test(SignupPsw);
                const allFilled = name && SignupEmail && SignupPsw && CheckPsw;
                const pswSame = SignupPsw == CheckPsw;
                const valid = passwordCheck && allFilled && pswSame && emailValid;

                $("#SignupBtn").prop("disabled", !valid);
            }

            //檢查電子郵件是否已被註冊
            async function CheckEmail(email) {
                try{
                    var res = await authFetch(`/api/members/check-email?email=${encodeURIComponent(email)}`,{method:"GET"});
                    const data = await res.json();
                    if(data.exist){
                        $("#emailWarn").text("電子郵件已註冊").show();
                        emailValid = false;
                    }else{
                        $("#emailWarn").hide();
                        emailValid = true;
                    }
                }
                catch{
                    $("#emailWarn").text("電子郵件無法檢查，請稍後再試").show();
                    emailValid = false;
                }
                SignupFormValid();
            }

            //註冊頁面輸入時錯誤訊息提示消失
            $("#name, #SignupEmail, #SignupPsw, #CheckPsw").on("input", () => {
                $(".text-danger").hide();
                SignupFormValid();
            });

            //註冊頁面失焦時檢查欄位填寫狀況
            $("#name,#SignupPsw, #CheckPsw").on("blur", (e) => {
                const id = e.target.id;
                const name = $("#name").val().trim();
                const psw = $("#SignupPsw").val().trim();
                const checkpsw = $("#CheckPsw").val().trim();

                if (id === "name") {
                    if (!name) { $("#nameWarn").show(); } else { $("#nameWarn").hide(); }
                }

                if (id === "SignupPsw") {
                    if (!psw) { $("#passwordWarn").text("密碼未填寫").show(); }
                    else if (!passwordPattern.test(psw)) { $("#passwordWarn").text("密碼長度未在8到15字元之間或未包含特殊字元、阿拉伯數字及大小寫英文字母").show(); }
                    else { $("#passwordWarn").hide(); }
                }

                if (id === "CheckPsw") {
                    if (!checkpsw) { $("#pswWarn").text("確認密碼未填寫").show(); }
                    else if (checkpsw != psw) { $("#pswWarn").text("密碼不一致").show(); }
                    else { $("#pswWarn").hide(); }
                }
                SignupFormValid();
            });

            //註冊頁面電子郵件欄位檢查是否已註冊
            $("#SignupEmail").on("blur", () => {
                const email = $("#SignupEmail").val().trim();
                const emailPattern = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;

                if (!email) { $("#emailWarn").text("電子郵件未填寫").show(); emailValid = false; return }
                else if (!emailPattern.test(email)) { $("#emailWarn").text("電子郵件格式不正確").show(); emailValid = false; return }
                else { $("#emailWarn").hide(); }
                CheckEmail(email);
            });

            //註冊頁面確認按鈕
            $("#SignupBtn").on("click", async () => {
                const name = $("#name").val().trim();
                const SignupEmail = $("#SignupEmail").val().trim();
                const SignupPsw = $("#SignupPsw").val().trim();

                try{
                    await signup(name,SignupEmail,SignupPsw)
                    Swal.fire({title:"註冊成功",icon:"success"}).then(()=>{
                        $("#name,#SignupEmail,#SignupPsw,#CheckPsw").val("");
                        $(".text-danger").hide();
                        emailValid = false;

                        $("#SignupBtn").prop("disabled",true);
                        window.location.href = "/Member/Index"
                    });
                }
                catch(err){
                    Swal.fire({title:err.message||"註冊失敗",icon:"error"});
                }
            });

            //登入頁面欄位填寫是否完整
            $("#LoginEmail,#LoginPsw").on("input",()=>{
                const email = $("#LoginEmail").val().trim();
                const psw = $("#LoginPsw").val().trim();

                if(email && psw){$("#LoginBtn").prop("disabled",false);}
                else{$("#LoginBtn").prop("disabled",true);}
            });

            //登入頁面確認按鈕
            $("#LoginBtn").on("click", async (e)=>{
                e.preventDefault();
                const email = $("#LoginEmail").val().trim();
                const psw = $("#LoginPsw").val().trim();

                try{
                    const result = await login(email,psw);
                    Swal.fire({
                        title: result.message || "登入成功",
                        icon:"success"
                    }).then(()=>{
                        $("#LoginEmail,#LoginPsw").val("");
                        $("#LoginBtn").prop("disabled",true);
                        window.location.href="/Product/Index";
                    });
                }
                catch (error){
                    Swal.fire({
                        title:"登入失敗",
                        text:error.message,
                        icon:"error"
                    });
                }
            });
        });
    </script>
}
