@{
    ViewData["Title"] = "我的訂單";
}
@section Styles{
    <style>
        .order-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }
        .order-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .order-list li:last-child {
            border-bottom: none;
        }
        .table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .table thead th {
            border: none;
            padding: 1rem;
            font-weight: 600;
        }
    </style>
}
<div class="container-fluid px-4 py-4">
    <div class="mb-4">
        <h2 class="fw-bold text-primary mb-2">
            <i class="bi bi-receipt-cutoff me-2"></i>我的訂單
        </h2>
        <p class="text-muted">查看您的訂單歷史記錄</p>
    </div>

    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="orderTable">
                <thead>
                    <tr>
                        <th><i class="bi bi-hash me-1"></i>訂單編號</th>
                        <th><i class="bi bi-calendar-event me-1"></i>下單時間</th>
                        <th><i class="bi bi-cash-coin me-1"></i>總金額</th>
                        <th><i class="bi bi-credit-card me-1"></i>付款狀態</th>
                        <th class="text-center"><i class="bi bi-gear me-1"></i>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // 格式化時間顯示（後端已經返回台灣時間，這裡只需要格式化）
        function formatTaiwanTime(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            
            // 檢查日期是否有效
            if (isNaN(date.getTime())) {
                return dateString;
            }
            
            // 直接格式化顯示（後端已經轉換為台灣時間）
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // 狀態映射函數，確保舊資料也能正確顯示
        function getPaymentStatusText(status) {
            const statusMap = {
                'Paid': '已付款',
                'Pending': '待付款',
                '已付款': '已付款',
                '待付款': '待付款'
            };
            return statusMap[status] || status || '待付款';
        }

        function isPaid(status) {
            return status === '已付款' || status === 'Paid';
        }

        document.addEventListener("DOMContentLoaded", loadOrders);

        async function loadOrders() {
            const res = await authFetch("/api/orders");
            const orders = await res.json();

            const tbody = document.querySelector("#orderTable tbody");
            tbody.innerHTML = "";

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-3 mb-0 fs-5">目前尚無訂單記錄</p>
                            <a href="/Product/Index" class="btn btn-outline-primary mt-3">
                                <i class="bi bi-arrow-left me-2"></i>前往商城選購
                            </a>
                        </td>
                    </tr>
                `;
                return;
            }

            orders.forEach(o => {
                const statusText = getPaymentStatusText(o.paymentStatus);
                const isPaidStatus = isPaid(o.paymentStatus);
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">#${o.orderId}</td>
                        <td>${formatTaiwanTime(o.createdAt)}</td>
                        <td class="fw-bold text-danger">NT$ ${o.totalAmount}</td>
                        <td><span class="badge bg-${isPaidStatus ? 'success' : 'warning'}">${statusText}</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary"
                                onclick="showDetail(${o.orderId})">
                                <i class="bi bi-eye me-1"></i>查看明細
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        async function showDetail(orderId) {
            const res = await authFetch(`/api/orders/${orderId}`);
            const order = await res.json();

            let html = `
                <div class="text-start">
                    <div class="mb-3">
                        <strong><i class="bi bi-hash me-1"></i>訂單編號：</strong>#${order.orderId}
                    </div>
                    <div class="mb-3">
                        <strong><i class="bi bi-calendar-event me-1"></i>下單時間：</strong>${formatTaiwanTime(order.createdAt)}
                    </div>
                    <div class="mb-3">
                        <strong><i class="bi bi-credit-card me-1"></i>付款狀態：</strong>
                        <span class="badge bg-${isPaid(order.paymentStatus) ? 'success' : 'warning'}">${getPaymentStatusText(order.paymentStatus)}</span>
                    </div>
                    <div class="mb-3">
                        <strong><i class="bi bi-cash-coin me-1"></i>總金額：</strong>
                        <span class="text-danger fw-bold fs-5">NT$ ${order.totalAmount}</span>
                    </div>
                    <hr>
                    <div class="mb-2"><strong><i class="bi bi-list-ul me-1"></i>商品明細：</strong></div>
                    <ul class="order-list">
            `;

            order.items.forEach(i => {
                html += `
                    <li class="d-flex justify-content-between align-items-center">
                        <span>${i.productName} × ${i.quantity}</span>
                        <span class="text-muted">NT$ ${i.unitPrice}</span>
                    </li>
                `;
            });

            html += "</ul></div>";

            Swal.fire({
                title: "<i class='bi bi-receipt-cutoff me-2'></i>訂單明細",
                html,
                width: 600,
                confirmButtonText: '關閉'
            });
        }

    </script>
}