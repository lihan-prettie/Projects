@{
    ViewData["Title"] = "我的訂單";
}
@section Styles{
    <style>
        .order-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

    </style>
}
<h2 class="mb-4">我的訂單</h2>

<table class="table table-bordered" id="orderTable">
    <thead>
        <tr>
            <th>訂單編號</th>
            <th>下單時間</th>
            <th>總金額</th>
            <th>付款狀態</th>
            <th></th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        document.addEventListener("DOMContentLoaded", loadOrders);

        async function loadOrders() {
            const res = await authFetch("/api/orders");
            const orders = await res.json();

            const tbody = document.querySelector("#orderTable tbody");
            tbody.innerHTML = "";

            orders.forEach(o => {
                tbody.innerHTML += `
                    <tr>
                        <td>#${o.orderId}</td>
                        <td>${new Date(o.createdAt).toLocaleString()}</td>
                        <td>NT$ ${o.totalAmount}</td>
                        <td>${o.paymentStatus}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                onclick="showDetail(${o.orderId})">
                                查看明細
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        async function showDetail(orderId) {
            const res = await authFetch(`/api/orders/${orderId}`);
            const order = await res.json();

            let html = `
                <p>訂單編號：#${order.orderId}</p>
                <p>下單時間：${new Date(order.createdAt).toLocaleString()}</p>
                <p>狀態：${order.paymentStatus}</p>
                <hr>
                <ul class="order-list">
            `;

            order.items.forEach(i => {
                html += `
                    <li>
                        ${i.productName} × ${i.quantity}
                        （NT$ ${i.unitPrice}）
                    </li>
                `;
            });

            html += "</ul>";

            Swal.fire({
                title: "訂單明細",
                html,
                width: 600
            });
        }

    </script>
}