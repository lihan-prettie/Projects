@{
    ViewData["Title"] = "結帳";
}

<div class="container-fluid px-4 py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="mb-4">
                <h2 class="fw-bold text-primary mb-2">
                    <i class="bi bi-cart-check me-2"></i>結帳確認
                </h2>
                <p class="text-muted">請確認您的訂單資訊</p>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>訂單內容</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4"><i class="bi bi-box-seam me-1"></i>商品</th>
                                    <th class="text-end">單價</th>
                                    <th class="text-center">數量</th>
                                    <th class="text-end pe-4">小計</th>
                                </tr>
                            </thead>
                            <tbody id="checkoutItems"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <span class="text-muted d-block mb-1">訂單總金額</span>
                            <span class="fs-2 fw-bold text-danger">
                                <i class="bi bi-currency-dollar me-1"></i>NT$ <span id="checkoutTotal">0</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between gap-3 flex-wrap">
                <button id="cancelBtn" class="btn btn-outline-secondary btn-lg px-4">
                    <i class="bi bi-arrow-left me-2"></i>返回購物車
                </button>
                <button id="checkoutBtn" class="btn btn-success btn-lg px-5 fw-bold">
                    <i class="bi bi-check-circle me-2"></i>確認結帳
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        document.addEventListener("DOMContentLoaded", loadCheckout);

        async function loadCheckout() {
            const res = await authFetch("/api/carts");
            if (!res.ok) {
                Swal.fire("請先登入", "", "warning")
                    .then(() => location.href = "/Member/Index");
                return;
            }

            const data = await res.json();
            console.log("購物車資料:", data); // 調試用

            const tbody = document.getElementById("checkoutItems");
            tbody.innerHTML = "";

            if (!data.items || data.items.length === 0) {
                tbody.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">
                                    <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                                    <p class="mt-3 mb-0 fs-5">購物車是空的</p>
                                    <a href="/Cart/Index" class="btn btn-outline-primary mt-3">
                                        <i class="bi bi-arrow-left me-2"></i>返回購物車
                                    </a>
                                </td>
                            </tr>
                        `;
                document.getElementById("checkoutBtn").disabled = true;
                return;
            }

            data.items.forEach(item => {
                // 支援 camelCase 和 PascalCase 兩種格式
                const productName = item.productName || item.ProductName;
                const price = item.price || item.Price;
                const quantity = item.quantity || item.Quantity;
                const subtotal = item.subtotal || item.Subtotal;

                tbody.innerHTML += `
                            <tr class="border-bottom">
                                <td class="fw-semibold ps-4">${productName}</td>
                                <td class="text-end">NT$${price}</td>
                                <td class="text-center">${quantity}</td>
                                <td class="text-end fw-bold text-danger pe-4">NT$${subtotal}</td>
                            </tr>
                        `;
            });

            const total = data.total || data.Total || 0;
            document.getElementById("checkoutTotal").innerText = total;
        }

        $("#checkoutBtn").on("click", async () => {
            $("#checkoutBtn").prop("disabled", true);

            try {
                // 1️⃣ 建立訂單
                const orderRes = await authFetch("/api/orders", {
                    method: "POST"
                });

                if (!orderRes.ok) throw new Error("建立訂單失敗");

                const orderData = await orderRes.json();
                const orderId = orderData.orderId;

                // 2️⃣ 建立付款流程
                const paymentRes = await authFetch(`/api/orders/${orderId}/payment`, {
                    method: "POST"
                });

                if (!paymentRes.ok) throw new Error("建立付款失敗");

                const paymentData = await paymentRes.json();

                // 3️⃣ 動態建立表單送到綠界
                const form = document.createElement("form");
                form.method = "POST";
                form.action = paymentData.paymentUrl;

                for (const key in paymentData.formData) {
                    const input = document.createElement("input");
                    input.type = "hidden";
                    input.name = key;
                    input.value = paymentData.formData[key];
                    form.appendChild(input);
                }

                document.body.appendChild(form);
                form.submit();

            } catch (err) {
                Swal.fire("結帳失敗", err.message, "error");
                $("#checkoutBtn").prop("disabled", false);
            }
        });


        $("#cancelBtn").on("click", () => {
            window.location.href = "/Cart/Index";
        });

    </script>
}
